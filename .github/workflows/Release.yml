name: release xcframework

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: macos-latest
    steps:
      - name: Get Version
        run: |
          echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
          
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Checkout Current
        uses: actions/checkout@v4
        with:
          path: 'current'
          
      - name: Checkout Alist-ios
        uses: actions/checkout@v4
        with:
          repository: 'gendago/alist-ios'
          ref: 'main'
          path: 'alist-ios'
      
      - name: Build Frameworks
        run: |
          cd alist-ios
          sh ./fetch-web.sh
          gomobile bind -target ios -bundleid app.inch.Alistlib -o Alistlib.xcframework -ldflags "-s -w" github.com/alist-org/alist/v3/alistlib

          cp ../current/Template.plist Info.plist
          plutil -replace CFBundleShortVersionString -string ${{ ENV.VERSION }} Info.plist
          cp Info.plist Alistlib.xcframework/ios-arm64/Alistlib.framework/Info.plist

          plutil -replace CFBundleSupportedPlatforms -array Info.plist
          plutil -insert CFBundleSupportedPlatforms.0 -string "iPhoneSimulator" Info.plist
          cp Info.plist Alistlib.xcframework/ios-arm64_x86_64-simulator/Alistlib.framework/Info.plist

          zip -r -X "Alistlib.xcframework.zip" "Alistlib.xcframework"

          cd ../
          
      - name: Compute Checksum
        run: |
          echo "CHECKSUM=$(swift package compute-checksum ./alist-ios/Alistlib.xcframework.zip)" >> $GITHUB_ENV

      - name: Update Package.swift
        run: |
          cd current
          DOWNLOAD_URL='https://github.com/InchStudio/Alistlib/releases/download/${{ env.VERSION }}/Alistlib.xcframework.zip'
          CHECKSUM=${{ env.CHECKSUM }}
          sed -i '' 's#\(url: "\).*\(",\)#\1${DOWNLOAD_URL}\2#' Package.swift
          sed -i '' 's#\(checksum: "\).*\(".*\)#\1${CHECKSUM}\2#' Package.swift

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add Package.swift
          git commit -m "Update version to ${{ ENV.VERSION }}"
          git push
          
      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          body: |
            ```swift
            .binaryTarget(
              name: "Alistlib",
              url: "https://github.com/InchStudio/Alistlib/releases/download/${{ env.VERSION }}/Alistlib.xcframework.zip",
              checksum: "${{ env.CHECKSUM }}"
            )
            ```
          allowUpdates: true
          artifacts: "alist-ios/Alistlib.xcframework.zip"
          token: ${{ secrets.USER_TOKEN }}
          tag: ${{ env.VERSION }}